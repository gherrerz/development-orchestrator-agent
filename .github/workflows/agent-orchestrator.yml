name: Agent Orchestrator

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  run-agent:
    if: startsWith(github.event.comment.body, '/agent run')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (runner tool)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install agent runner deps
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      - name: Extract request (stack/language/test_command)
        id: req
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python -m agent.tools.extract_request

      # Toolchains based on requested language
      - name: Setup Node
        if: steps.req.outputs.language == 'javascript' || steps.req.outputs.language == 'typescript' || startsWith(steps.req.outputs.stack, 'node-')
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java
        if: steps.req.outputs.language == 'java' || startsWith(steps.req.outputs.stack, 'java-')
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup .NET
        if: steps.req.outputs.language == 'dotnet' || steps.req.outputs.language == 'csharp' || startsWith(steps.req.outputs.stack, 'dotnet-')
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Go
        if: steps.req.outputs.language == 'go' || startsWith(steps.req.outputs.stack, 'go-')
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install project deps (multi-stack)
        env:
          STACK: ${{ steps.req.outputs.stack }}
          LANGUAGE: ${{ steps.req.outputs.language }}
          TEST_COMMAND: ${{ steps.req.outputs.test_command }}
        run: |
          python -m agent.tools.stack_setup

      - name: Run orchestrator
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_EMBED_MODEL: ${{ secrets.OPENAI_EMBED_MODEL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_NAMESPACE_PREFIX: ${{ secrets.PINECONE_NAMESPACE_PREFIX }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m agent.orchestrator

      - name: Comment back to Issue (robust)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          BODY_FILE="agent/out/summary.md"
          if [ -f "$BODY_FILE" ]; then
            BODY="$(cat "$BODY_FILE")"
          else
            BODY="⚠️ El agente falló antes de generar summary.md. Revisa logs del workflow."
          fi

          # retry/backoff for GitHub 429 throttling
          for i in 1 2 3 4 5; do
            if gh issue comment "$ISSUE_NUMBER" --body "$BODY"; then
              exit 0
            fi
            sleep $((i*i))
          done

          echo "::error::No se pudo comentar en el issue (reintentos agotados)."
          exit 1
