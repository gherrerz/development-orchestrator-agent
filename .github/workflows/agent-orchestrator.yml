name: agent-orchestrator

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run:
    if: contains(github.event.comment.body, '/agent run')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install agent deps
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      - name: Install project deps (best-effort)
        run: |
          python -m pip install --upgrade pip
          # Siempre asegurar pytest disponible
          pip install pytest

          # Instalar dependencias del repo si existen
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

          if [ -f pyproject.toml ]; then
            # Best-effort: si usa poetry/uv no lo asumimos; intentamos extras comunes
            pip install .
          fi

      - name: Debug patch_apply.py (CI truth)
        run: |
          echo "=== git rev-parse HEAD ==="
          git rev-parse HEAD
          echo "=== show patch_apply.py first 80 lines ==="
          nl -ba agent/tools/patch_apply.py | sed -n '1,80p'
          echo "=== functions present? ==="
          grep -n "def apply_unified_diff" -n agent/tools/patch_apply.py || true
          grep -n "def looks_like_valid_unified_diff" -n agent/tools/patch_apply.py || true

      - name: Run Orchestrator
        env:
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
            OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
            PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
            PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
            PINECONE_NAMESPACE_PREFIX: ${{ secrets.PINECONE_NAMESPACE_PREFIX }}
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            REPO: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            COMMENT_BODY: ${{ github.event.comment.body }}
            COMMENT_ID: ${{ github.event.comment.id }}
            PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m agent.orchestrator

      - name: Comment back to Issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          if [ -f agent/out/summary.md ]; then
            gh issue comment "$ISSUE_NUMBER" --body "$(cat agent/out/summary.md)"
          else
            gh issue comment "$ISSUE_NUMBER" --body "⚠️ El agente falló antes de generar summary.md. Revisa logs del workflow."
          fi
