name: Agent Orchestrator (Issue Command)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run-agent:
    if: startsWith(github.event.comment.body, '/agent run')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract stack/language/test_command from comment
        id: req
        shell: bash
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - << 'PY'
          import os, re, json
          body = os.environ.get("COMMENT_BODY","")
          m = re.search(r"\{.*\}", body, re.S)
          stack = ""
          lang = ""
          test_cmd = ""
          if m:
            req = json.loads(m.group(0))
            stack = (req.get("stack") or "").strip()
            lang = (req.get("language") or "").strip()
            test_cmd = (req.get("test_command") or "").strip()

            if not lang:
              if stack.startswith("python-"): lang = "python"
              elif stack.startswith("java-"): lang = "java"
              elif stack.startswith("node-"): lang = "node"
              elif stack.startswith("dotnet-"): lang = "dotnet"
              elif stack.startswith("go-"): lang = "go"

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"stack={stack}\n")
            f.write(f"language={lang}\n")
            f.write(f"test_command={test_cmd}\n")
          print("stack=", stack, "language=", lang, "test_command=", test_cmd)
          PY

      # ---------- Agent runtime (always Python) ----------
      - name: Setup Python (agent runtime)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install agent deps
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      # ---------- Target toolchains (conditional) ----------
      - name: Setup Java (Temurin)
        if: steps.req.outputs.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Setup Node
        if: steps.req.outputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup .NET
        if: steps.req.outputs.language == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Go
        if: steps.req.outputs.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Install project deps (stack-aware + catalog) ----------
      - name: Install project deps (stack-aware + catalog)
        shell: bash
        env:
          STACK: ${{ steps.req.outputs.stack }}
          LANGUAGE: ${{ steps.req.outputs.language }}
        run: |
          set -euo pipefail
          echo "STACK=$STACK"
          echo "LANGUAGE=$LANGUAGE"

          python -m pip install --upgrade pip

          # Base tools (Python stacks)
          if [ "$LANGUAGE" = "python" ] || [ -z "$LANGUAGE" ]; then
            pip install pytest
          fi

          # Heuristics: install repo-declared deps first
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ]; then
            pip install .
          fi

          # Stack catalog reinforcement (best-effort)
          if [ -f agent/stacks/catalog.yml ]; then
            python -m pip install pyyaml || true

            python - <<'PY' > /tmp/stack_deps.sh
          import os
          try:
            import yaml
          except Exception:
            print("::warning::PyYAML not available; skipping catalog extras.")
            raise SystemExit(0)

          stack = (os.environ.get("STACK") or "").strip()
          if not stack:
            raise SystemExit(0)

          with open("agent/stacks/catalog.yml","r",encoding="utf-8") as f:
            catalog = yaml.safe_load(f) or {}

          spec = catalog.get(stack) or {}
          deps = spec.get("deps", {}) or {}
          pip_deps = deps.get("pip", []) or []
          npm_deps = deps.get("npm", []) or []

          if pip_deps:
            print("python -m pip install " + " ".join(pip_deps))
          if npm_deps:
            print("npm install " + " ".join(npm_deps))
          PY

            if [ -s /tmp/stack_deps.sh ]; then
              echo "== catalog extras =="
              cat /tmp/stack_deps.sh
              bash /tmp/stack_deps.sh
            fi
          fi

          # Minimal safety nets for common stacks (if repo didn't declare deps yet)
          if [ "$STACK" = "python-django" ]; then
            python - <<'PY'
            import importlib.util
            missing=[]
            for pkg in ["django","pytest_django"]:
              if importlib.util.find_spec(pkg) is None:
                missing.append(pkg)
            if missing:
              print("python -m pip install django pytest-django")
            PY | bash
          fi

          if [ "$STACK" = "python-fastapi-postgres" ]; then
            python - <<'PY'
            import importlib.util
            missing=[]
            for pkg in ["fastapi"]:
              if importlib.util.find_spec(pkg) is None:
                missing.append(pkg)
            if missing:
              print("python -m pip install fastapi 'uvicorn[standard]' httpx")
            PY | bash
          fi

      # ---------- Run orchestrator ----------
      - name: Run Orchestrator
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PYTHONPATH: ${{ github.workspace }}

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_EMBED_MODEL: ${{ secrets.OPENAI_EMBED_MODEL }}

          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_NAMESPACE_PREFIX: ${{ secrets.PINECONE_NAMESPACE_PREFIX }}
        run: |
          python -m agent.orchestrator

      - name: Upload agent artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-out
          path: agent/out

      # ---------- Comment summary back robustly ----------
      - name: Comment back to Issue (robust)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set +e

          # Prefer truncation to avoid huge payloads
          if [ -f agent/out/summary.md ]; then
            head -c 8000 agent/out/summary.md > agent/out/summary.trunc.md
          fi

          post_comment () {
            if [ -f agent/out/summary.trunc.md ]; then
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body-file agent/out/summary.trunc.md
            elif [ -f agent/out/summary.md ]; then
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body-file agent/out/summary.md
            else
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "⚠️ El agente falló antes de generar summary.md. Revisa logs del workflow."
            fi
          }

          for i in 1 2 3 4 5; do
            post_comment
            rc=$?
            if [ $rc -eq 0 ]; then
              echo "✅ Issue comment posted"
              exit 0
            fi
            echo "⚠️ Failed to post comment (rc=$rc). Retrying... ($i/5)"
            sleep $((i * i * 10))
          done

          echo "⚠️ Could not post comment after retries (likely rate limited). Not failing workflow."
          exit 0
