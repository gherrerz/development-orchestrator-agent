name: Agent Orchestrator

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: agent-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  run-agent:
    # Hard gate: only run for /agent run and trusted authors
    if: >
      startsWith(github.event.comment.body, '/agent run') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug orchestrator version
        run: |
          python -c "import agent.orchestrator, inspect; print(agent.orchestrator.__file__); print('normalize_patch' in dir(agent.orchestrator))"

      - name: Setup Python (runner tool)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            agent/requirements.txt
            requirements.txt
            pyproject.toml

      - name: Install agent runner deps
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      - name: Extract request (stack/language/test_command)
        id: req
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python -m agent.tools.extract_request

      # Toolchains based on resolved language
      - name: Setup Node
        if: steps.req.outputs.toolchain_kind == 'node' || steps.req.outputs.language == 'javascript' || steps.req.outputs.language == 'typescript' || startsWith(steps.req.outputs.stack, 'node-')
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.req.outputs.toolchain_version != '' && steps.req.outputs.toolchain_version || '20' }}
          cache: ${{ steps.req.outputs.package_manager != '' && steps.req.outputs.package_manager || 'npm' }}
          cache-dependency-path: |
            package-lock.json
            pnpm-lock.yaml
            yarn.lock

      - name: Setup Java (no cache here; cache is conditional below)
        if: steps.req.outputs.toolchain_kind == 'java' || steps.req.outputs.language == 'java' || startsWith(steps.req.outputs.stack, 'java-')
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ steps.req.outputs.toolchain_version != '' && steps.req.outputs.toolchain_version || '21' }}

      - name: Cache Maven repository (only if pom.xml exists)
        if: (steps.req.outputs.toolchain_kind == 'java' || steps.req.outputs.language == 'java' || startsWith(steps.req.outputs.stack, 'java-')) && hashFiles('**/pom.xml') != ''
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Cache Gradle (only if Gradle wrapper exists)
        if: (steps.req.outputs.toolchain_kind == 'java' || steps.req.outputs.language == 'java' || startsWith(steps.req.outputs.stack, 'java-')) && (hashFiles('**/gradle-wrapper.properties') != '' || hashFiles('**/gradlew') != '')
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties', '**/*.gradle*', '**/settings.gradle*') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Setup .NET
        if: steps.req.outputs.toolchain_kind == 'dotnet' || steps.req.outputs.language == 'dotnet' || steps.req.outputs.language == 'csharp' || startsWith(steps.req.outputs.stack, 'dotnet-')
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ steps.req.outputs.toolchain_version != '' && steps.req.outputs.toolchain_version || '8.0.x' }}

      - name: Cache NuGet packages
        if: steps.req.outputs.toolchain_kind == 'dotnet'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.fsproj', '**/*.vbproj', '**/*.sln', '**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Setup Go
        if: steps.req.outputs.toolchain_kind == 'go' || steps.req.outputs.language == 'go' || startsWith(steps.req.outputs.stack, 'go-')
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.req.outputs.toolchain_version != '' && steps.req.outputs.toolchain_version || '1.22.x' }}
          cache: true
          cache-dependency-path: |
            **/go.sum

      - name: Install project deps (multi-stack)
        env:
          STACK: ${{ steps.req.outputs.stack }}
          LANGUAGE: ${{ steps.req.outputs.language }}
          TEST_COMMAND: ${{ steps.req.outputs.test_command }}
        run: |
          python -m agent.tools.stack_setup

      - name: Run orchestrator
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_EMBED_MODEL: ${{ secrets.OPENAI_EMBED_MODEL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_NAMESPACE_PREFIX: ${{ secrets.PINECONE_NAMESPACE_PREFIX }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m agent.orchestrator

      - name: Upload agent artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-out
          path: agent/out
          if-no-files-found: ignore

      - name: Comment back to Issue (robust)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          BODY_FILE="agent/out/summary.md"
          if [ -f "$BODY_FILE" ]; then
            BODY="$(cat "$BODY_FILE")"
          else
            BODY="⚠️ El agente falló antes de generar summary.md. Revisa logs del workflow."
          fi

          for i in 1 2 3 4 5; do
            if gh issue comment "$ISSUE_NUMBER" --body "$BODY"; then
              exit 0
            fi
            sleep $((i*i))
          done

          echo "::error::No se pudo comentar en el issue (reintentos agotados)."
          exit 1
