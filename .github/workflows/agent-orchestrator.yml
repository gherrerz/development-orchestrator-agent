name: Agent Orchestrator (Issue Command)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run-agent:
    if: startsWith(github.event.comment.body, '/agent run')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract stack/language/test_command from comment
        id: req
        shell: bash
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - << 'PY'
          import os, re, json
          body = os.environ.get("COMMENT_BODY","")
          m = re.search(r"\{.*\}", body, re.S)
          stack = ""
          lang = ""
          test_cmd = ""
          if m:
            req = json.loads(m.group(0))
            stack = (req.get("stack") or "").strip()
            lang = (req.get("language") or "").strip()
            test_cmd = (req.get("test_command") or "").strip()

            if not lang:
              if stack.startswith("python-"): lang = "python"
              elif stack.startswith("java-"): lang = "java"
              elif stack.startswith("node-"): lang = "node"
              elif stack.startswith("dotnet-"): lang = "dotnet"
              elif stack.startswith("go-"): lang = "go"

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"stack={stack}\n")
            f.write(f"language={lang}\n")
            f.write(f"test_command={test_cmd}\n")
          print("stack=", stack, "language=", lang, "test_command=", test_cmd)
          PY

      # ---------- Agent runtime (always Python) ----------
      - name: Setup Python (agent runtime)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install agent deps
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt

      # ---------- Target toolchains (conditional) ----------
      - name: Setup Java (Temurin)
        if: steps.req.outputs.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Setup Node
        if: steps.req.outputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup .NET
        if: steps.req.outputs.language == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Go
        if: steps.req.outputs.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Install project deps (auto + catalog reinforcement) ----------
      - name: Install project deps (auto + catalog)
        shell: bash
        env:
          STACK: ${{ steps.req.outputs.stack }}
        run: |
          set -euo pipefail
          echo "STACK=$STACK"

          # Auto install by common files (best-effort)

          # Python project heuristics
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ]; then
            pip install .
          fi

          # Node project heuristics
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          fi

          # Java project heuristics
          if [ -f pom.xml ]; then
            mvn -q -DskipTests package
          fi
          if [ -f gradlew ]; then
            chmod +x ./gradlew
            ./gradlew -q assemble
          fi

          # .NET project heuristics
          if ls *.sln >/dev/null 2>&1 || ls *.csproj >/dev/null 2>&1; then
            dotnet restore
          fi

          # Go project heuristics
          if [ -f go.mod ]; then
            go mod download
          fi

          # Stack catalog reinforcement (installs extras when repo doesn't declare them yet)
          if [ -f agent/stacks/catalog.yml ]; then
            python - << 'PY'
          import os, sys, subprocess
          from pathlib import Path

          stack = os.environ.get("STACK","").strip()
          if not stack:
              print("No stack provided; skipping catalog.")
              sys.exit(0)

          try:
              import yaml
          except Exception:
              print("PyYAML not installed; skipping catalog.")
              sys.exit(0)

          repo = Path(".")
          has_requirements = (repo / "requirements.txt").is_file()
          has_pyproject = (repo / "pyproject.toml").is_file()
          has_package_json = (repo / "package.json").is_file()

          with open("agent/stacks/catalog.yml","r",encoding="utf-8") as f:
              catalog = yaml.safe_load(f) or {}

          spec = catalog.get(stack)
          if not spec:
              print(f"Stack '{stack}' not in catalog; skipping.")
              sys.exit(0)

          deps = spec.get("deps",{}) or {}
          pip_deps = deps.get("pip",[]) or []
          npm_deps = deps.get("npm",[]) or []

          def run(cmd):
              print("+", " ".join(cmd))
              subprocess.run(cmd, check=False)

          # ✅ Bonus gating:
          # - Si el repo ya declara deps Python/Node, NO instales pip/npm del catálogo.
          if pip_deps:
              if has_requirements or has_pyproject:
                  print("Repo already declares Python deps (requirements.txt/pyproject.toml). Skipping catalog pip deps.")
              else:
                  run([sys.executable, "-m", "pip", "install", *pip_deps])

          if npm_deps:
              if has_package_json:
                  print("Repo already declares Node deps (package.json). Skipping catalog npm deps.")
              else:
                  if subprocess.call(["bash","-lc","command -v npm >/dev/null 2>&1"]) == 0:
                      run(["npm", "install", *npm_deps])
                  else:
                      print("npm not available; skipping npm deps.")
          PY
          fi

      - name: Debug context
        run: |
          echo "=== git rev-parse HEAD ==="
          git rev-parse HEAD
          echo "=== stack/language ==="
          echo "STACK=${{ steps.req.outputs.stack }}"
          echo "LANG=${{ steps.req.outputs.language }}"
          echo "TEST_COMMAND=${{ steps.req.outputs.test_command }}"

      # ---------- Run orchestrator ----------
      - name: Run Orchestrator
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PYTHONPATH: ${{ github.workspace }}

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_EMBED_MODEL: ${{ secrets.OPENAI_EMBED_MODEL }}

          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_NAMESPACE_PREFIX: ${{ secrets.PINECONE_NAMESPACE_PREFIX }}
        run: |
          python -m agent.orchestrator

      # ---------- Comment summary back robustly ----------
      - name: Comment back to Issue (robust)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set +e

          # Prefer truncation to avoid huge payloads
          if [ -f agent/out/summary.md ]; then
            head -c 8000 agent/out/summary.md > agent/out/summary.trunc.md
          fi

          post_comment () {
            if [ -f agent/out/summary.trunc.md ]; then
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body-file agent/out/summary.trunc.md
            elif [ -f agent/out/summary.md ]; then
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body-file agent/out/summary.md
            else
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "⚠️ El agente falló antes de generar summary.md. Revisa logs del workflow."
            fi
          }

          for i in 1 2 3 4 5; do
            post_comment
            rc=$?
            if [ $rc -eq 0 ]; then
              echo "✅ Issue comment posted"
              exit 0
            fi
            echo "⚠️ Failed to post comment (rc=$rc). Retrying... ($i/5)"
            sleep $((i * i * 10))
          done

          echo "⚠️ Could not post comment after retries (likely rate limited). Not failing workflow."
          exit 0