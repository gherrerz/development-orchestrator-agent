# Stack catalog (data-driven)
# Add new stacks here without touching orchestrator/stack_setup code.
# Fields:
#   language: python|javascript|typescript|java|dotnet|go|...
#   toolchain: { kind: python|node|java|dotnet|go, version: "<version>" }
#   deps: { apt:[], pip:[], npm:[] }
#   commands: { test:"...", build:"...", lint:"..." }
#   allowed_test_prefixes: ["..."]  # security allowlist prefixes for test_command
#   markers: { any_of: ["glob", ...] }  # if none exist => repo not initialized for this stack
#   bootstrap:
#     kind: none|template|command
#     templates: [{path:"...", content:"..."}]
#     commands: ["..."]

python-fastapi-postgres:
  language: python
  toolchain: { kind: python, version: "3.11" }
  markers:
    any_of: ["pyproject.toml", "requirements.txt"]
  deps:
    pip:
      - fastapi
      - "uvicorn[standard]"
      - httpx
      - psycopg2-binary
      - pytest
  commands:
    test: "pytest -q"
  allowed_test_prefixes: ["pytest", "python -m pytest"]

python-django:
  language: python
  toolchain: { kind: python, version: "3.11" }

  # Markers para detectar que el repo YA es Django
  markers:
    any_of:
      - "manage.py"
      - "pyproject.toml"
      - "requirements.txt"
      - "config/settings.py"
      - "*/settings.py"

  # Bootstrap real (solo se aplicará cuando NO existan markers y el stack elegido sea python-django)
  # Objetivo: repo runnable + tests "meaningful" (evitar exit=0 con 0 tests/skipped)
  bootstrap:
    kind: template
    templates:
      - path: "requirements.txt"
        content: |
          Django>=5.0,<6.0
          djangorestframework>=3.14,<4.0
          pytest>=7.0,<9.0
          pytest-django>=4.5,<5.0

      - path: "manage.py"
        content: |
          #!/usr/bin/env python
          import os
          import sys

          def main():
              os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
              try:
                  from django.core.management import execute_from_command_line
              except ImportError as exc:
                  raise ImportError(
                      "Couldn't import Django. Are you sure it's installed and available on your PYTHONPATH?"
                  ) from exc
              execute_from_command_line(sys.argv)

          if __name__ == "__main__":
              main()

      - path: "config/__init__.py"
        content: |
          # Django project package

      - path: "config/settings.py"
        content: |
          from pathlib import Path

          BASE_DIR = Path(__file__).resolve().parent.parent

          SECRET_KEY = "dev-secret-key-change-me"
          DEBUG = True
          ALLOWED_HOSTS = ["*"]

          INSTALLED_APPS = [
              "django.contrib.admin",
              "django.contrib.auth",
              "django.contrib.contenttypes",
              "django.contrib.sessions",
              "django.contrib.messages",
              "django.contrib.staticfiles",
              "rest_framework",
          ]

          MIDDLEWARE = [
              "django.middleware.security.SecurityMiddleware",
              "django.contrib.sessions.middleware.SessionMiddleware",
              "django.middleware.common.CommonMiddleware",
              "django.middleware.csrf.CsrfViewMiddleware",
              "django.contrib.auth.middleware.AuthenticationMiddleware",
              "django.contrib.messages.middleware.MessageMiddleware",
              "django.middleware.clickjacking.XFrameOptionsMiddleware",
          ]

          ROOT_URLCONF = "config.urls"

          TEMPLATES = [
              {
                  "BACKEND": "django.template.backends.django.DjangoTemplates",
                  "DIRS": [],
                  "APP_DIRS": True,
                  "OPTIONS": {
                      "context_processors": [
                          "django.template.context_processors.request",
                          "django.contrib.auth.context_processors.auth",
                          "django.contrib.messages.context_processors.messages",
                      ],
                  },
              }
          ]

          WSGI_APPLICATION = "config.wsgi.application"

          # SQLite por defecto para evitar dependencias externas
          DATABASES = {
              "default": {
                  "ENGINE": "django.db.backends.sqlite3",
                  "NAME": BASE_DIR / "db.sqlite3",
              }
          }

          AUTH_PASSWORD_VALIDATORS = []

          LANGUAGE_CODE = "es-cl"
          TIME_ZONE = "UTC"
          USE_I18N = True
          USE_TZ = True

          STATIC_URL = "static/"
          DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

      - path: "config/urls.py"
        content: |
          from django.contrib import admin
          from django.urls import path

          urlpatterns = [
              path("admin/", admin.site.urls),
              path("health/", lambda request: None),
          ]

      - path: "config/wsgi.py"
        content: |
          import os
          from django.core.wsgi import get_wsgi_application

          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
          application = get_wsgi_application()

      - path: "config/asgi.py"
        content: |
          import os
          from django.core.asgi import get_asgi_application

          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
          application = get_asgi_application()

      - path: "pytest.ini"
        content: |
          [pytest]
          DJANGO_SETTINGS_MODULE = config.settings
          python_files = test_*.py *_test.py tests.py
          addopts = -q

      # Test mínimo "meaningful" para que pytest siempre ejecute algo
      - path: "tests/test_smoke.py"
        content: |
          import pytest

          @pytest.mark.django_db
          def test_smoke():
              assert 1 + 1 == 2

  deps:
    pip:
      - django
      - djangorestframework
      - psycopg2-binary
      - pytest
      - pytest-django

  commands:
    test: "pytest -q"

  allowed_test_prefixes:
    - "pytest"
    - "python -m pytest"


java-spring-boot:
  language: java
  toolchain: { kind: java, version: "21" }

  markers:
    any_of:
      - "pom.xml"
      - "**/pom.xml"
      - "build.gradle"
      - "build.gradle.kts"
      - "**/build.gradle"
      - "**/build.gradle.kts"

  bootstrap:
    kind: template
    templates:
      - path: "pom.xml"
        content: |
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>

            <parent>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-parent</artifactId>
              <version>3.3.0</version>
              <relativePath/>
            </parent>

            <groupId>com.example</groupId>
            <artifactId>app</artifactId>
            <version>0.0.1-SNAPSHOT</version>
            <name>app</name>

            <properties>
              <java.version>21</java.version>
            </properties>

            <dependencies>
              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
              </dependency>

              <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <scope>test</scope>
              </dependency>
            </dependencies>

            <build>
              <plugins>
                <plugin>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-maven-plugin</artifactId>
                </plugin>

                <!-- Enterprise: make test discovery deterministic -->
                <plugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-surefire-plugin</artifactId>
                  <version>3.2.5</version>
                  <configuration>
                    <includes>
                      <include>**/*Test.java</include>
                      <include>**/*Tests.java</include>
                      <include>**/*IT.java</include>
                    </includes>
                    <trimStackTrace>false</trimStackTrace>
                  </configuration>
                </plugin>
              </plugins>
            </build>
          </project>

      - path: "src/main/java/com/example/Application.java"
        content: |
          package com.example;

          import org.springframework.boot.SpringApplication;
          import org.springframework.boot.autoconfigure.SpringBootApplication;

          @SpringBootApplication
          public class Application {
              public static void main(String[] args) {
                  SpringApplication.run(Application.class, args);
              }
          }

      - path: "src/test/java/com/example/ApplicationTests.java"
        content: |
          package com.example;

          import org.junit.jupiter.api.Test;
          import org.springframework.boot.test.context.SpringBootTest;

          @SpringBootTest
          class ApplicationTests {
              @Test
              void contextLoads() {}
          }

  deps:
    apt: [maven]

  commands:
    test: "mvn -Dstyle.color=never test"
    build: "mvn -Dstyle.color=never -DskipTests package"

  # With the new orchestrator policy, this is now "defense in depth" not brittle matching
  allowed_test_prefixes:
    - "mvn"
    - "./mvnw"
    - "./gradlew"

# -----------------------------
# NODE stacks (bootstrap templates)
# -----------------------------
node-express:
  language: javascript
  toolchain: { kind: node, version: "20" }
  markers:
    any_of: ["package.json", "**/package.json"]
  bootstrap:
    kind: template
    templates:
      - path: "package.json"
        content: |
          {
            "name": "app",
            "version": "0.1.0",
            "private": true,
            "type": "commonjs",
            "scripts": {
              "test": "node -e \"console.log('ok: no tests yet')\"",
              "start": "node src/index.js"
            },
            "dependencies": {},
            "devDependencies": {}
          }
      - path: "src/index.js"
        content: |
          const http = require("http");
          const server = http.createServer((req, res) => {
            res.statusCode = 200;
            res.setHeader("Content-Type", "text/plain");
            res.end("OK\n");
          });
          server.listen(process.env.PORT || 3000, () => console.log("listening"));
      - path: ".gitignore"
        content: |
          node_modules
          dist
          .env
  deps:
    npm: [express]
  commands:
    test: "npm test"
  allowed_test_prefixes:
    - "npm test"
    - "npm run test"
    - "pnpm test"
    - "pnpm run test"
    - "yarn test"

node-react:
  language: javascript
  toolchain: { kind: node, version: "20" }
  markers:
    any_of: ["package.json", "**/package.json"]
  bootstrap:
    kind: template
    templates:
      - path: "package.json"
        content: |
          {
            "name": "app",
            "version": "0.1.0",
            "private": true,
            "type": "module",
            "scripts": {
              "test": "node -e \"console.log('ok: no tests yet')\""
            },
            "dependencies": {},
            "devDependencies": {}
          }
      - path: ".gitignore"
        content: |
          node_modules
          dist
          .env
  deps:
    npm: [react, react-dom]
  commands:
    test: "npm test"
  allowed_test_prefixes:
    - "npm test"
    - "npm run test"
    - "pnpm test"
    - "pnpm run test"
    - "yarn test"

node-angular:
  language: typescript
  toolchain: { kind: node, version: "20" }
  markers:
    any_of: ["package.json", "**/package.json"]
  bootstrap:
    kind: template
    templates:
      - path: "package.json"
        content: |
          {
            "name": "app",
            "version": "0.1.0",
            "private": true,
            "type": "module",
            "scripts": {
              "test": "node -e \"console.log('ok: no tests yet')\""
            },
            "dependencies": {},
            "devDependencies": {}
          }
      - path: ".gitignore"
        content: |
          node_modules
          dist
          .env
  deps:
    npm: ["@angular/core", "@angular/cli"]
  commands:
    test: "npm test"
  allowed_test_prefixes:
    - "npm test"
    - "npm run test"
    - "pnpm test"
    - "pnpm run test"
    - "yarn test"

# -----------------------------
# .NET (bootstrap commands)
# -----------------------------
dotnet-webapi:
  language: dotnet
  toolchain: { kind: dotnet, version: "8.0.x" }
  markers:
    any_of:
      - "*.sln"
      - "**/*.sln"
      - "*.csproj"
      - "**/*.csproj"
  bootstrap:
    kind: command
    commands:
      - |
        if ! ls *.sln >/dev/null 2>&1 && ! ls **/*.sln >/dev/null 2>&1 && ! ls *.csproj >/dev/null 2>&1 && ! ls **/*.csproj >/dev/null 2>&1; then
          dotnet new sln -n app
          dotnet new webapi -n app
          dotnet sln app.sln add app/app.csproj
        fi
  deps: {}
  commands:
    test: "dotnet test"
  allowed_test_prefixes: ["dotnet test"]

# -----------------------------
# Go (bootstrap commands + main.go template)
# -----------------------------
go-fiber:
  language: go
  toolchain: { kind: go, version: "1.22.x" }
  markers:
    any_of: ["go.mod", "**/go.mod"]
  bootstrap:
    kind: command
    commands:
      - |
        if [ ! -f go.mod ]; then
          go mod init example.com/app
          go get github.com/gofiber/fiber/v2@latest
        fi
      - |
        if [ ! -f main.go ]; then
          cat > main.go <<'EOF'
          package main

          import "github.com/gofiber/fiber/v2"

          func main() {
              app := fiber.New()
              app.Get("/", func(c *fiber.Ctx) error { return c.SendString("OK") })
              _ = app.Listen(":3000")
          }
          EOF
        fi
  deps: {}
  commands:
    test: "go test ./..."
  allowed_test_prefixes:
    - "go test ./..."
    - "go test ./... -v"
    - "go test ./... -count=1"
